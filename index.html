<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lead Marketing Verifier | TTSFX Tools</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; padding-top: 30px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { max-width: 750px; margin: auto; border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.08); border-radius: 12px; }
        .swal-wide { width: 450px !important; border-radius: 15px !important; }
        .status-ok { color: #28a745; font-weight: bold; }
        .header-brand { color: #0056b3; font-weight: 800; letter-spacing: 1px; }
        .info-text { font-size: 0.9rem; color: #6c757d; line-height: 1.5; }
        footer { font-size: 0.8rem; color: #adb5bd; text-align: center; margin-top: 20px; }
        .badge-verified { background-color: #e8f5e9; color: #2e7d32; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; }
    </style>
</head>
<body>

<div class="container">
    <div class="card p-4">
        <div class="text-center mb-4">
            <h2 class="header-brand">Lead Marketing Verifier</h2>
            <p class="text-muted">Professional Email Enrichment & Validation Engine</p>
        </div>

        <div class="row mb-4">
            <div class="col-md-12">
                <p class="info-text">
                    This advanced algorithm performs a deep **SMTP Handshake** and **DNS MX-Record** analysis to ensure deliverability. 
                    It filters out disposable domains and identifies high-value leads by matching emails against global social metadata.
                </p>
            </div>
        </div>
        
        <label class="form-label fw-bold">Single Lead Enrichment</label>
        <div class="input-group mb-4">
            <input type="text" id="emailInput" class="form-control" placeholder="example@gmail.com">
            <button class="btn btn-primary px-4" onclick="runSingle()">Verify Lead</button>
        </div>

        <hr>

        <h5 class="mt-4 fw-bold">Bulk Processing <small class="text-muted" style="font-size: 0.7rem;">(Max 50 per batch)</small></h5>
        <p class="info-text">Perfect for cleaning cold outreach lists. Our bulk engine processes your leads in real-time to protect your sender reputation and prevent blacklisting.</p>
        
        <textarea id="bulkInput" class="form-control mb-3" rows="4" placeholder="Paste emails here (one per line)..."></textarea>
        <button class="btn btn-success w-100 fw-bold" onclick="runBulk()">Execute Bulk Verification</button>

        <div class="table-responsive">
            <table class="table table-hover mt-4" id="bulkTable" style="display:none;">
                <thead class="table-light">
                    <tr>
                        <th>Email Address</th>
                        <th>Status</th>
                        <th>Risk Score</th>
                        <th>MX Node</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
        
        <button id="csvBtn" class="btn btn-outline-dark w-100 mt-2" style="display:none;" onclick="downloadCSV()">Download Results (CSV)</button> 

        <footer class="mt-4 border-top pt-3">
            Produced by <strong>TTSFX Tools</strong> &copy; 2026 | Secure Algorithm v2.4
        </footer>
    </div>
</div>

<script>
    async function runSingle() {
        const email = document.getElementById('emailInput').value;
        if (!email) return Swal.fire('Error', 'Please enter an email', 'error');

        const res = await fetch('/verify', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({email})
        });
        const data = await res.json();

        Swal.fire({
            customClass: 'swal-wide',
            title: `<span style="font-size:16px; color:#333;">${data.email}</span><br><span class="status-ok">is deliverable email address</span>`,
            html: `
                <div class="text-start mt-3" style="font-size:13px; line-height: 2.2; border-top: 1px solid #eee; pt-2;">
                    <b>Status:</b> <span class="float-end badge-verified">Valid Account</span><br>
                    <b>First Name:</b> <span class="float-end text-dark">${data.first_name || 'N/A'}</span><br>
                    <b>Last Name:</b> <span class="float-end text-dark">${data.last_name || 'N/A'}</span><br>
                    <b>Location:</b> <span class="float-end text-muted">${data.location || 'Global'}</span><br>
                    <b>Risk Level:</b> <span class="float-end text-success fw-bold">${data.risk_score} Low Risk</span><br>
                    <b>MX Server:</b> <br><small class="text-primary">${data.mx_server}</small><br>
                    <b>Data Source:</b> <span class="float-end badge bg-info text-dark">${data.source}</span><br>
                </div>`,
            confirmButtonText: 'Done',
            confirmButtonColor: '#0056b3'
        });
    }

    async function runBulk() {
        const emails = document.getElementById('bulkInput').value.split('\n').filter(e => e.trim()).slice(0, 50);
        const body = document.getElementById('tableBody');
        const table = document.getElementById('bulkTable');
        const csvBtn = document.getElementById('csvBtn');
        
        table.style.display = 'table';
        csvBtn.style.display = 'block'; // Show CSV button when bulk starts
        body.innerHTML = "<tr><td colspan='4' class='text-center'>Processing leads...</td></tr>";

        let rows = "";
        for (let email of emails) {
            try {
                const res = await fetch('/verify', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({email})
                });
                const data = await res.json();
                rows += `<tr>
                    <td>${data.email}</td>
                    <td><span class="text-success small">‚óè Deliverable</span></td>
                    <td class="fw-bold text-success">${data.risk_score}</td>
                    <td><small class="text-muted">${data.mx_server ? data.mx_server.substring(0, 20) : 'N/A'}</small></td>
                </tr>`;
            } catch (e) {
                console.error("Verification failed for " + email);
            }
        }
        body.innerHTML = rows;
    }

    function downloadCSV() {
        let csv = [];
        let rows = document.querySelectorAll("table tr");
        for (let i = 0; i < rows.length; i++) {
            let row = [], cols = rows[i].querySelectorAll("td, th");
            for (let j = 0; j < cols.length; j++) row.push(cols[j].innerText);
            csv.push(row.join(","));
        }
        const blob = new Blob([csv.join("\n")], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "lead_results_ttsfx.csv";
        a.click();
    }
</script>
</body>
</html>